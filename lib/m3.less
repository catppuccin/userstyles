#__m3 {
  .rgb(@id, @color) {
    --@{id}: @color;
    --@{id}-rgb: #lib.rgbify(@color)[];
  }

  .token(@id, @color) {
    --@{prefix}@{id}: @color;
    --@{prefix}@{id}-rgb: #lib.rgbify(@color)[];
  }

  .base() {
    @m3-primary: @accent;
    @m3-secondary: desaturate(@accent, 15%);
    @m3-tertiary: lighten(@accent, 5%);
    @m3-emphasize: 5%;
    @m3-deemphasize: 10%;
    @m3-tint: 30%;

    @m3-inverse-flavor: if(@flavor = latte, mocha, latte);
    @m3-black: @catppuccin[@mocha][@crust];
  }

  .with-prefix(@prefix) {
    .token(background, @base);
    .token(error, @red);
    .token(error-container, fade(@red, @m3-tint));
    .token(inverse-on-surface, @base);
    // m3-primary
    .token(inverse-primary, @catppuccin[@@m3-inverse-flavor][@@accentColor]);
    .token(inverse-surface, @text);
    .token(on-background, @text);
    .token(on-error, @base);
    .token(on-error-container, lighten(@red, @m3-emphasize));
    .token(on-primary, @base);
    .token(on-primary-container, lighten(@m3-primary, @m3-emphasize));
    .token(on-primary-fixed, @catppuccin[@mocha][@base]);
    .token(on-primary-fixed-variant, @catppuccin[@mocha][@base]);
    .token(on-secondary, @base);
    .token(on-secondary-container, lighten(@m3-secondary, @m3-emphasize));
    .token(on-secondary-fixed, @catppuccin[@mocha][@base]);
    .token(on-secondary-fixed-variant, @catppuccin[@mocha][@base]);
    .token(on-surface, @text);
    .token(on-surface-variant, @subtext0);
    .token(on-tertiary, @base);
    .token(on-tertiary-container, lighten(@m3-tertiary, @m3-emphasize));
    .token(on-tertiary-fixed, @catppuccin[@mocha][@base]);
    .token(on-tertiary-fixed-variant, @catppuccin[@mocha][@base]);
    .token(outline, @overlay2);
    .token(outline-variant, @overlay0);
    .token(primary, @m3-primary);
    .token(primary-container, fade(@m3-primary, @m3-tint));
    // m3-primary
    .token(primary-fixed, @catppuccin[@mocha][@@accentColor]);
    // m3-primary
    .token(
      primary-fixed-dim,
      darken(@catppuccin[@mocha][@@accentColor], @m3-deemphasize),
    );
    .token(scrim, @m3-black);
    .token(secondary, @m3-secondary);
    .token(secondary-container, fade(@m3-secondary, @m3-tint));
    // m3-secondary
    .token(
      secondary-fixed,
      desaturate(@catppuccin[@mocha][@@accentColor], 15%),
    );
    // m3-secondary
    .token(
      secondary-fixed-dim,
      darken(
        desaturate(@catppuccin[@mocha][@@accentColor], 15%),
        @m3-deemphasize
      ),
    );
    .token(shadow, @m3-black);
    .token(surface, @base);
    .token(surface-bright, @surface0);
    .token(surface-container, @surface0);
    .token(surface-container-high, @surface1);
    .token(surface-container-highest, @surface2);
    .token(surface-container-low, @mantle);
    .token(surface-container-lowest, @crust);
    .token(surface-dim, @mantle);
    .token(surface-tint, @accent);
    .token(surface-variant, @overlay1);
    .token(tertiary, @m3-tertiary);
    .token(tertiary-container, fade(@m3-tertiary, @m3-tint));
    // m3-tertiary
    .token(tertiary-fixed, lighten(@catppuccin[@mocha][@@accentColor], 5%));
    // m3-tertiary
    .token(
      tertiary-fixed-dim,
      darken(lighten(@catppuccin[@mocha][@@accentColor], 5%), @m3-deemphasize),
    );
  }
}
